var diesel=function(parent){parent.router={_started:false,_routes:{},_settings:{history:true,onError:function(route){throw new Error("Route does not exist.",route)}},_parse:function(route){var base="",found=false,isValid=false,matchingRoutes=Object.keys(this._routes),param="",params={},partial="/",parts=route.split("/").slice(1),prefix="";if("*"in this._routes)this._routes["*"](route);for(var i=0,ilen=parts.length;i<ilen;i++){base=partial+prefix;partial=base+parts[i];matchingRoutes=matchingRoutes.filter(function(route){return route.indexOf(base)===0});if(partial in this._routes){this._routes[partial](params);isValid=true}else{found=false;param="";for(var j=0,jlen=matchingRoutes.length;j<jlen;j++){if(matchingRoutes[j].charAt(base.length)===":"){found=true;break}}if(found){param=matchingRoutes[j].slice(base.length+1).split("/")[0];params[param]=parts[i];partial=base+":"+param;if(partial in this._routes){this._routes[partial](params);isValid=true}else{isValid=false}}else{isValid=false}}prefix="/"}if(!isValid)this._settings.onError(route)},_routeChangeHandler:function(){var route=location[this._settings.history?"pathname":"hash"];route=route.slice(route.indexOf("/"));if(route==="")route="/";this._parse(route)},config:function(newSettings){for(var prop in newSettings){this._settings[prop]=newSettings[prop]}return this},navigateTo:function(route){if(!this._started){throw new Error("Attempted to navigate before starting router.");return false}if(this._settings.history){history.pushState(null,"",route);this._routeChangeHandler()}else{location.hash=route}},start:function(){this._started=true;if(this._settings.history&&!("history"in window))this._settings.history=false;window.onpopstate=function(){diesel.router._routeChangeHandler()};this._routeChangeHandler()},stop:function(){this._started=false;window.onpopstate=function(){}},when:function(route,callback){this._routes[route]=callback;return this}};return parent}(diesel||{});